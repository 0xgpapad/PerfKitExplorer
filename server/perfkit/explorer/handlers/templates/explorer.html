<!DOCTYPE html>
<html lang="en" ng-app="explorer" ng-controller="ExplorerCtrl as explorerCtrl">
<head>
  <title>Perfkit - {{ explorerCtrl.dashboard.current.model.title }}</title>

  <!-- JQuery & Angular -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular-mocks.js"></script>

  <!-- AngularUI Grid -->
  <script src="/static/third_party/uiGrid/ui-grid.js"></script>
  <link href="/static/third_party/uiGrid/ui-grid.css" rel="stylesheet">

  <!-- CodeMirror3 Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/3.24.0/codemirror.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/3.24.0/mode/javascript/javascript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/3.24.0/mode/sql/sql.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/3.24.0/codemirror.css" rel="stylesheet">

  <!-- Bootstrap & Bootstrap UI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>

  <script>
    // Record page view in Google Analytics.
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', '[[analytics_key]]', 'googleplex.com');
    ga('send', 'pageview');

    // Initialize Google Visualizations
    try {
      google.load('visualization', '1.1', {packages: [
        'corechart', 'charteditor', 'calendar', 'geochart', 'sankey']});
    } catch (err) { }

    var CURRENT_USER_EMAIL = '[[current_user_email]]';
    var CURRENT_USER_ADMIN = [[current_user_admin]];
    [% autoescape false %]
    var INITIAL_CONFIG =  [[initial_config]];
    [% endautoescape %]
  </script>

  <!-- Perfkit -->
  <script src="[[static_dir]]/perfkit_scripts.js"></script>
  <link type="text/css" rel="stylesheet" href="[[static_dir]]/perfkit_styles.css" />
</head>
<body>

<div class="perfkit-page">

  <explorer-header></explorer-header>

  <div class="perfkit-page-body" ng-controller="DashboardCtrl as dashboardCtrl">

    <div class="perfkit-page-sidebar-left"
         ng-controller="QueryEditorCtrl as queryEditorCtrl"
         ng-show="dashboardCtrl.dashboard.selectedContainer && !explorerCtrl.explorer.model.readOnly">

      <query-editor />

    </div>

    <div class="perfkit-page-content">
      <div id="result-table">
        <div>

          <div class="spinner" ng-show="dashboardCtrl.dashboardIsLoading"></div>

          <div ng-repeat="container in dashboardCtrl.dashboard.widgets" class="perfkit-container"
               ng-class="{'perfkit-container-selected': widget.state().selected}">

            <container class="perfkit-container-content" container-config="container">
              <perfkit-widget class="perfkit-widget"
                      ng-repeat="widget in container.model.container.children"
                      widget-config="widget">
                <div class="perfkit-widget-header"
                     ng-click="dashboardCtrl.dashboard.selectWidget(widget, container)">
                  <span class="glyphicon glyphicon-remove" style="float: right; margin-left: 4px; cursor: pointer"
                        ng-hide="explorerCtrl.explorer.model.readOnly"
                        ng-click="dashboardCtrl.dashboard.removeWidget(widget, container)"></span>
                  <span class="glyphicon glyphicon-refresh" style="float: right; margin-left: 4px; cursor: pointer"
                        ng-click="dashboardCtrl.dashboard.refreshWidget(widget)"></span>
                  <a style="float: right; margin-left: 4px"
                     ng-show="widget.model.url" ng-href="{{ widget.model.url }}">
                    <span class="glyphicon glyphicon-link"></span>
                  </a>
                  <div class="perfkit-widget-title" ng-bind="widget.model.title"></div>
                </div>
                <div class="perfkit-widget-content"
                     ng-click="dashboardCtrl.dashboard.selectWidget(widget, container)">
                  <gviz-chart-widget widget-config="widget"/>
                </div>
              </perfkit-widget>
            </container>
          </div>

          <div ng-hide="explorerCtrl.explorer.model.readOnly">
            <button class="btn btn-primary"
                    ng-click="explorerCtrl.dashboard.addContainer()">INSERT CONTAINER</button>
          </div>
        </div>
      </div>
    </div>

    <div class="perfkit-page-sidebar-right"
         ng-show="dashboardCtrl.dashboard.selectedContainer && !explorerCtrl.explorer.model.readOnly">
      <span class="glyphicon glyphicon-remove perfkit-glyph-button perfkit-sidebar-button"
            ng-click="dashboardCtrl.dashboard.selectWidget(null, null)"></span>

      <dashboard-config ng-model="dashboardCtrl.dashboard.current.model"></dashboard-config>

      <container-config ng-model="dashboardCtrl.dashboard.selectedContainer.model"></container-config>

      <chart-config ng-model="dashboardCtrl.dashboard.selectedWidget.model"></chart-config>

    </div>
  </div>

  <div class="perfkit-page-footer"
       ng-show="explorerCtrl.dashboard.selectedWidget || explorerCtrl.explorer.model.code_editor.isOpen">
    <widget-editor></widget-editor>
  </div>
</div>
</body>
</html>
